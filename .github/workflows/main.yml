name: build-and-deploy-aci

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: rag-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ACR Login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and Push (linux/amd64)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -f ./Dockerfile \
            -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --push \
            .

      - name: Deploy to Azure Container Instance (Linux)
        uses: azure/cli@v2
        with:
          inlineScript: |
            az container delete --yes \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.IMAGE_NAME }} || true

            az container create \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.IMAGE_NAME }} \
              --image ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --os-type Linux \
              --restart-policy Always \
              --cpu 1 --memory 2 \
              --ports 8000 \
              --ip-address Public \
              --dns-name-label ${{ env.IMAGE_NAME }}-${{ github.run_number }} \
              --registry-login-server ${{ secrets.REGISTRY_LOGIN_SERVER }} \
              --registry-username ${{ secrets.REGISTRY_USERNAME }} \
              --registry-password ${{ secrets.REGISTRY_PASSWORD }} \
              --environment-variables \
                AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }} \
                AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }} \
                AZURE_OPENAI_API_VERSION=${{ secrets.AZURE_OPENAI_API_VERSION }} \
                AZURE_OPENAI_DEPLOYMENT_NAME=${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}

            echo "FQDN:"
            az container show \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.IMAGE_NAME }} \
              --query ipAddress.fqdn -o tsv
